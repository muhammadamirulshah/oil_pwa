<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BUDI Subsidy Calculator</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding-bottom: 70px; /* space for bottom navbar */
    }
    h1, h2 {
      text-align: center;
      color: #007bff;
    }
    .navbar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #007bff;
      color: white;
      font-weight: bold;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      border-top: 2px solid #0056b3;
      z-index: 100;
    }
    .navbar div {
      cursor: pointer;
      text-align: center;
      flex: 1;
    }
    .navbar div.active {
      text-decoration: underline;
      background: #0056b3;
    }
    .page {
      display: none;
      padding: 20px;
    }
    .active-page {
      display: block;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 450px;
      margin: 20px auto;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .secondary { background: #6c757d; }
    .secondary:hover { background: #5a6268; }
    .danger { background: #dc3545; }
    .danger:hover { background: #b02a37; }
    .result, .history-entry {
      margin-top: 15px;
      background: #e9ecef;
      padding: 10px;
      border-radius: 6px;
    }
    canvas {
      max-width: 350px;
      margin: 0 auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>BUDI Subsidy Calculator</h1>

  <!-- ===== CALCULATOR PAGE ===== -->
  <div id="calc" class="page active-page">
    <div class="card">
      <label>Petrol Station</label>
      <select id="station">
        <option value="">-- Select Station --</option>
        <option>PETRONAS</option>
        <option>SHELL</option>
        <option>PETRON</option>
        <option>CALTEX</option>
        <option>BHP</option>
        <option>BURAQ</option>
        <option>FIVE</option>
        <option>XCELL</option>
        <option>OTHERS</option>
      </select>

      <label>Opening Balance (L)</label>
      <input type="number" id="openingBalance" readonly>

      <label>Liters Used (L)</label>
      <input type="number" id="litersUsed" placeholder="optional" step="0.01">

      <label>Amount Paid (RM)</label>
      <input type="number" id="amountPaid" placeholder="required" step="0.01">

      <button onclick="calculate()">Calculate</button>
      <button class="secondary" onclick="clearInputs()">Clear Input</button>
      <button class="danger" onclick="resetQuota()">Reset Quota (300L)</button>

      <div id="result" class="result"></div>
    </div>
  </div>

  <!-- ===== SUMMARY PAGE ===== -->
  <div id="summary" class="page">
    <h2>ðŸ“Š Monthly Summary</h2>
    <div class="card">
      <label>Filter by Petrol Station</label>
      <select id="filterStation" onchange="updateSummary()">
        <option value="">All Stations</option>
        <option>PETRONAS</option>
        <option>SHELL</option>
        <option>PETRON</option>
        <option>CALTEX</option>
        <option>BHP</option>
        <option>BURAQ</option>
        <option>FIVE</option>
        <option>XCELL</option>
        <option>OTHERS</option>
      </select>
      <canvas id="summaryChart"></canvas>
      <div id="summaryText" class="result"></div>
    </div>
  </div>

  <!-- ===== HISTORY PAGE ===== -->
  <div id="history" class="page">
    <h2>ðŸ§¾ Transaction History</h2>
    <div id="historyList"></div>
    <button class="secondary" onclick="clearHistory()">Clear History</button>
  </div>

  <!-- ===== NAVBAR (BOTTOM) ===== -->
  <div class="navbar">
    <div id="navCalc" class="active" onclick="switchPage('calc')">ðŸ§®<br>Calc</div>
    <div id="navSummary" onclick="switchPage('summary')">ðŸ“Š<br>Summary</div>
    <div id="navHistory" onclick="switchPage('history')">ðŸ§¾<br>History</div>
  </div>

  <!-- âœ… Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUBSIDIZED_PRICE = 1.99;
    const MARKET_PRICE = 2.60;
    const QUOTA = 300;

    let currentBalance = parseFloat(localStorage.getItem('budi_balance')) || QUOTA;
    let history = JSON.parse(localStorage.getItem('budi_history')) || [];

    document.getElementById('openingBalance').value = currentBalance.toFixed(2);

    // Navigation
    function switchPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
      document.getElementById(pageId).classList.add('active-page');
      document.querySelectorAll('.navbar div').forEach(n => n.classList.remove('active'));
      document.getElementById('nav' + pageId.charAt(0).toUpperCase() + pageId.slice(1)).classList.add('active');
      if (pageId === 'history') renderHistory();
      if (pageId === 'summary') updateSummary();
    }

    // Calculator
    function calculate() {
      const station = document.getElementById('station').value;
      const opening = currentBalance;
      const usedInput = document.getElementById('litersUsed').value;
      const paid = parseFloat(document.getElementById('amountPaid').value) || 0;

      if (!station) return alert("Please select petrol station.");
      if (paid <= 0) return alert("Please enter amount paid.");

      let used = parseFloat(usedInput);
      if (!used || used <= 0) used = paid / SUBSIDIZED_PRICE;

      const withinQuota = Math.min(used, opening);
      const balanceAfter = Math.max(opening - used, 0);

      const totalNoSubsidy = used * MARKET_PRICE;
      const subsidyAmount = withinQuota * (MARKET_PRICE - SUBSIDIZED_PRICE);
      const totalWithSubsidy = totalNoSubsidy - subsidyAmount;

      currentBalance = balanceAfter;
      localStorage.setItem('budi_balance', currentBalance);
      document.getElementById('openingBalance').value = currentBalance.toFixed(2);

      document.getElementById('result').innerHTML = `
        <b>${station}</b><br>
        Without Subsidy: RM ${totalNoSubsidy.toFixed(2)}<br>
        Subsidy: RM ${subsidyAmount.toFixed(2)}<br>
        Total (After Subsidy): RM ${totalWithSubsidy.toFixed(2)}<br>
        You Paid: RM ${paid.toFixed(2)}<br>
        <hr>
        Remaining Quota: ${balanceAfter.toFixed(2)} L
      `;

      const record = {
        date: new Date().toLocaleString(),
        station, used, paid,
        totalNoSubsidy, subsidyAmount, totalWithSubsidy, balanceAfter
      };

      history.unshift(record);
      localStorage.setItem('budi_history', JSON.stringify(history));
    }

    function clearInputs() {
      document.getElementById('station').value = '';
      document.getElementById('litersUsed').value = '';
      document.getElementById('amountPaid').value = '';
      document.getElementById('result').innerHTML = '';
    }

    function resetQuota() {
      if (confirm("Reset your quota to 300L?")) {
        currentBalance = QUOTA;
        localStorage.setItem('budi_balance', currentBalance);
        document.getElementById('openingBalance').value = currentBalance.toFixed(2);
        alert("Quota reset to 300L.");
      }
    }

    // History
    function renderHistory() {
      const container = document.getElementById('historyList');
      container.innerHTML = '';
      if (history.length === 0) {
        container.innerHTML = '<i>No history yet.</i>';
        return;
      }
      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-entry';
        div.innerHTML = `
          <b>${item.station}</b> â€” ${item.date}<br>
          Used: ${item.used.toFixed(2)}L | Paid: RM ${item.paid.toFixed(2)}<br>
          Subsidy: RM ${item.subsidyAmount.toFixed(2)} | After Subsidy: RM ${item.totalWithSubsidy.toFixed(2)}<br>
          Remaining: ${item.balanceAfter.toFixed(2)}L
        `;
        container.appendChild(div);
      });
    }

    function clearHistory() {
      if (confirm("Clear all history?")) {
        history = [];
        localStorage.removeItem('budi_history');
        renderHistory();
      }
    }

    // Summary
    let chart;
    function updateSummary() {
      const stationFilter = document.getElementById('filterStation').value;
      const filtered = stationFilter ? history.filter(h => h.station === stationFilter) : history;

      const totalUsed = filtered.reduce((a,b) => a + b.used, 0);
      const totalPaid = filtered.reduce((a,b) => a + b.paid, 0);
      const totalSubsidy = filtered.reduce((a,b) => a + b.subsidyAmount, 0);
      const totalAfter = filtered.reduce((a,b) => a + b.totalWithSubsidy, 0);

      document.getElementById('summaryText').innerHTML = `
        <b>Total Records:</b> ${filtered.length}<br>
        <b>Total Liters Used:</b> ${totalUsed.toFixed(2)} L<br>
        <b>Total Paid:</b> RM ${totalPaid.toFixed(2)}<br>
        <b>Total Subsidy:</b> RM ${totalSubsidy.toFixed(2)}<br>
        <b>Total After Subsidy:</b> RM ${totalAfter.toFixed(2)}
      `;

      const ctx = document.getElementById('summaryChart').getContext('2d');
      const data = {
        labels: ["Subsidy", "Paid by User"],
        datasets: [{
          data: [totalSubsidy, totalAfter],
          backgroundColor: ["#28a745", "#007bff"]
        }]
      };

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'pie',
        data,
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
