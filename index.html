<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BUDI Petrol Subsidy Calculator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      color: #007bff;
      padding-top: 10px;
    }
    .navbar {
      display: flex;
      justify-content: space-around;
      background: #007bff;
      color: white;
      position: fixed;
      bottom: 0;
      width: 100%;
      border-top: 1px solid #0056b3;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      cursor: pointer;
    }
    .nav-item.active {
      background: #0056b3;
      font-weight: bold;
    }
    .page {
      display: none;
      padding: 20px;
      max-width: 480px;
      margin: 0 auto 60px auto;
    }
    .active-page {
      display: block;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .secondary { background: #6c757d; }
    .secondary:hover { background: #5a6268; }
    .danger { background: #dc3545; }
    .danger:hover { background: #b02a37; }
    .history-entry {
      background: #fff;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      font-size: 14px;
    }
  </style>
</head>

<body>
  <h1>BUDI Subsidy PWA</h1>

  <!-- Calculator Page -->
  <div id="page-calculator" class="page active-page">
    <div class="card">
      <label>Petrol Station</label>
      <select id="station">
        <option value="">-- Select Station --</option>
        <option>PETRONAS</option>
        <option>SHELL</option>
        <option>PETRON</option>
        <option>CALTEX</option>
        <option>BHP</option>
        <option>BURAQ</option>
        <option>FIVE</option>
        <option>XCELL</option>
        <option>OTHERS</option>
      </select>

      <label>Opening Balance (L)</label>
      <input type="number" id="openingBalance" readonly step="0.01">

      <label>Liters Used (Optional)</label>
      <input type="number" id="litersUsed" placeholder="Leave blank to auto-calc" step="0.01">

      <label>Amount Paid (RM)*</label>
      <input type="number" id="amountPaid" placeholder="e.g. 10" step="0.01">

      <button onclick="calculate()">Calculate</button>
      <button class="secondary" onclick="clearInputs()">Clear Input</button>
      <button class="danger" onclick="resetQuota()">Reset Quota (300L)</button>

      <div id="result" class="card" style="background:#e9ecef;margin-top:15px;"></div>
    </div>
  </div>

  <!-- Summary Page -->
  <div id="page-summary" class="page">
    <div class="card">
      <h3>ðŸ“Š Summary</h3>
      <label>Filter by Station:</label>
      <select id="filterStation" onchange="renderSummary()">
        <option value="ALL">ALL</option>
        <option>PETRONAS</option>
        <option>SHELL</option>
        <option>PETRON</option>
        <option>CALTEX</option>
        <option>BHP</option>
        <option>BURAQ</option>
        <option>FIVE</option>
        <option>XCELL</option>
        <option>OTHERS</option>
      </select>
      <div id="summaryContent" style="margin-top:10px;"></div>
      <canvas id="summaryChart" style="margin-top:15px;"></canvas>
      <button class="secondary" onclick="downloadHistory()">Download CSV</button>
    </div>
  </div>

  <!-- History Page -->
  <div id="page-history" class="page">
    <div class="card">
      <h3>â›½ History Log</h3>
      <div id="historyList"></div>
      <button class="secondary" onclick="clearHistory()">Clear History</button>
    </div>
  </div>

  <!-- Navbar -->
  <div class="navbar">
    <div class="nav-item active" onclick="switchPage('calculator', this)">Calculator</div>
    <div class="nav-item" onclick="switchPage('summary', this)">Summary</div>
    <div class="nav-item" onclick="switchPage('history', this)">History</div>
  </div>

  <script>
    const SUBSIDIZED_PRICE = 1.99;
    const MARKET_PRICE = 2.60;
    const QUOTA = 300;

    let currentBalance = parseFloat(localStorage.getItem('budi_balance')) || QUOTA;
    let history = JSON.parse(localStorage.getItem('budi_history')) || [];
    let summaryChart = null;

    document.getElementById('openingBalance').value = currentBalance.toFixed(2);
    renderHistory();
    renderSummary();

    // ===== Calculator Logic =====
    function calculate() {
      const station = document.getElementById('station').value;
      const opening = currentBalance;
      const usedInput = parseFloat(document.getElementById('litersUsed').value);
      const paid = parseFloat(document.getElementById('amountPaid').value);

      if (!paid || paid <= 0) {
        alert("Please enter amount paid.");
        return;
      }
      if (!station) {
        alert("Please select petrol station.");
        return;
      }

      let used = usedInput;
      if (isNaN(used)) {
        let pricePerLiter = opening > 0 ? SUBSIDIZED_PRICE : MARKET_PRICE;
        used = paid / pricePerLiter;
      }

      const balanceAfter = Math.max(opening - used, 0);
      const withinQuota = Math.min(used, opening);
      const totalNoSubsidy = used * MARKET_PRICE;
      const subsidyAmount = withinQuota * (MARKET_PRICE - SUBSIDIZED_PRICE);
      const totalWithSubsidy = totalNoSubsidy - subsidyAmount;

      currentBalance = balanceAfter;
      localStorage.setItem('budi_balance', currentBalance);
      document.getElementById('openingBalance').value = currentBalance.toFixed(2);

      document.getElementById('result').innerHTML = `
        <b>Results:</b><br>
        Station: ${station}<br>
        Liters Used: ${used.toFixed(2)} L<br>
        Without Subsidy: RM ${totalNoSubsidy.toFixed(2)}<br>
        Subsidy: RM ${subsidyAmount.toFixed(2)}<br>
        Total After Subsidy: RM ${totalWithSubsidy.toFixed(2)}<br>
        You Paid: RM ${paid.toFixed(2)}<br>
        <hr>Remaining Quota: ${balanceAfter.toFixed(2)} L
      `;

      const record = {
        date: new Date().toLocaleString(),
        station,
        used,
        paid,
        totalNoSubsidy,
        subsidyAmount,
        totalWithSubsidy,
        balanceAfter
      };
      history.unshift(record);
      localStorage.setItem('budi_history', JSON.stringify(history));
      renderHistory();
      renderSummary();
    }

    function clearInputs() {
      document.getElementById('station').value = '';
      document.getElementById('litersUsed').value = '';
      document.getElementById('amountPaid').value = '';
      document.getElementById('result').innerHTML = '';
    }

    function resetQuota() {
      if (confirm('Reset quota back to 300L?')) {
        currentBalance = QUOTA;
        localStorage.setItem('budi_balance', currentBalance);
        document.getElementById('openingBalance').value = currentBalance.toFixed(2);
        alert('Quota reset to 300L');
      }
    }

    // ===== History =====
    function renderHistory() {
      const container = document.getElementById('historyList');
      container.innerHTML = history.length === 0 ? "<i>No history yet.</i>" : "";
      history.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'history-entry';
        div.innerHTML = `
          <b>${item.station}</b> â€” ${item.date}<br>
          Used: ${item.used.toFixed(2)}L | Paid: RM ${item.paid.toFixed(2)}<br>
          Total (No Subsidy): RM ${item.totalNoSubsidy.toFixed(2)}<br>
          Subsidy: RM ${item.subsidyAmount.toFixed(2)}<br>
          After Subsidy: RM ${item.totalWithSubsidy.toFixed(2)}<br>
          Remaining Quota: ${item.balanceAfter.toFixed(2)}L
        `;
        container.appendChild(div);
      });
    }

    function clearHistory() {
      if (confirm("Clear all history?")) {
        history = [];
        localStorage.removeItem('budi_history');
        renderHistory();
        renderSummary();
      }
    }

    function downloadHistory() {
      if (history.length === 0) {
        alert("No history to download.");
        return;
      }
      let csv = "Date,Station,Liters Used,Paid (RM),No Subsidy (RM),Subsidy (RM),After Subsidy (RM),Remaining Quota (L)\n";
      history.forEach(h => {
        csv += `${h.date},${h.station},${h.used.toFixed(2)},${h.paid.toFixed(2)},${h.totalNoSubsidy.toFixed(2)},${h.subsidyAmount.toFixed(2)},${h.totalWithSubsidy.toFixed(2)},${h.balanceAfter.toFixed(2)}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "budi_history.csv";
      link.click();
    }

    // ===== Summary =====
    function renderSummary() {
      const filter = document.getElementById('filterStation').value;
      const filtered = filter === "ALL" ? history : history.filter(h => h.station === filter);
      const summary = document.getElementById('summaryContent');

      if (filtered.length === 0) {
        summary.innerHTML = "<i>No records to summarize.</i>";
        if (summaryChart) summaryChart.destroy();
        return;
      }

      const totalLiters = filtered.reduce((sum, h) => sum + h.used, 0);
      const totalPaid = filtered.reduce((sum, h) => sum + h.paid, 0);
      const totalSubsidy = filtered.reduce((sum, h) => sum + h.subsidyAmount, 0);

      summary.innerHTML = `
        Total Transactions: ${filtered.length}<br>
        Total Liters: ${totalLiters.toFixed(2)} L<br>
        Total Paid: RM ${totalPaid.toFixed(2)}<br>
        Total Subsidy: RM ${totalSubsidy.toFixed(2)}
      `;

      const ctx = document.getElementById('summaryChart');
      if (summaryChart) summaryChart.destroy();
      summaryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Total Paid', 'Total Subsidy'],
          datasets: [{
            data: [totalPaid, totalSubsidy],
            backgroundColor: ['#007bff', '#28a745'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
          }
        }
      });
    }

    // ===== Navbar =====
    function switchPage(page, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
      document.getElementById('page-' + page).classList.add('active-page');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
    }

    // ===== Service Worker =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
